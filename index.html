<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RaffleFi - Lending with Raffle Rewards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    
    <!-- Header -->
    <div class="bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <span class="text-white text-2xl">üéÅ</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">RaffleFi</h1>
                        <p class="text-xs text-gray-500">Lending with Raffle Rewards</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <button id="refreshBtn" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <span id="refreshIcon">üîÑ</span>
                    </button>
                    <button id="connectBtn" class="px-6 py-2.5 rounded-lg font-medium transition-all bg-indigo-600 text-white hover:bg-indigo-700">
                        <span>üîå Connect Wallet</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status Message -->
    <div id="statusMessage" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
        <div id="statusContent" class="p-4 rounded-lg"></div>
    </div>
    
    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Current Raffle Banner -->
        <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 rounded-2xl p-6 mb-8 text-white">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-white/20 backdrop-blur rounded-full flex items-center justify-center">
                        <span class="text-3xl">üéÅ</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold">Current Raffle #<span id="raffleId">0</span></h2>
                        <p class="text-indigo-100">Hourly rewards for lenders</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 bg-white/20 backdrop-blur px-4 py-2 rounded-full">
                    <span>‚è∞</span>
                    <span class="font-semibold" id="timeRemaining">Not started</span>
                </div>
            </div>
            
            <div class="grid grid-cols-4 gap-4">
                <div class="bg-white/10 backdrop-blur rounded-lg p-4">
                    <p class="text-indigo-100 text-sm mb-1">Total Prize Pool</p>
                    <p class="text-3xl font-bold"><span id="rewardPool">0</span> mUSDC</p>
                </div>
                <div class="bg-white/10 backdrop-blur rounded-lg p-4">
                    <p class="text-indigo-100 text-sm mb-1">Winners</p>
                    <p class="text-3xl font-bold">10</p>
                </div>
                <div class="bg-white/10 backdrop-blur rounded-lg p-4">
                    <p class="text-indigo-100 text-sm mb-1">Participants</p>
                    <p class="text-3xl font-bold" id="participants">0</p>
                </div>
                <div class="bg-white/10 backdrop-blur rounded-lg p-4">
                    <p class="text-indigo-100 text-sm mb-1">Your Tickets</p>
                    <p class="text-3xl font-bold" id="yourTickets">0</p>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                    <!-- Tabs -->
                    <div class="flex border-b border-gray-200">
                        <button id="lendTab" class="flex-1 px-6 py-4 font-semibold bg-indigo-50 text-indigo-600 border-b-2 border-indigo-600">
                            Lend
                        </button>
                        <button id="dashboardTab" class="flex-1 px-6 py-4 font-semibold text-gray-600 hover:bg-gray-50">
                            Dashboard
                        </button>
                    </div>
                    
                    <div class="p-6">
                        <!-- Lend Content -->
                        <div id="lendContent">
                            <!-- Approval Section -->
                            <div id="approvalSection" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 hidden">
                                <div class="flex items-start space-x-3">
                                    <span class="text-yellow-600 text-xl">‚ö†Ô∏è</span>
                                    <div class="flex-1">
                                        <p class="text-sm text-yellow-800 mb-3">
                                            <strong>First time?</strong> You need to approve the contract to spend your tokens.
                                        </p>
                                        <button id="approveBtn" class="bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-yellow-700 transition-colors">
                                            Approve Tokens
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Deposit Section -->
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Deposit & Earn Raffle Tickets</h3>
                                <p class="text-sm text-gray-600 mb-4">
                                    Your balance: <strong id="userBalance">0</strong> mUSDC
                                </p>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Deposit Amount</label>
                                        <div class="relative">
                                            <input type="number" id="depositAmount" placeholder="0.00" 
                                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                            <span class="absolute right-4 top-3.5 text-gray-500 font-medium">mUSDC</span>
                                        </div>
                                        <p class="text-sm text-indigo-600 mt-2" id="ticketsPreview"></p>
                                    </div>
                                    
                                    <button id="depositBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                                        Deposit
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Withdraw Section -->
                            <div class="border-t pt-6">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Withdraw</h3>
                                <p class="text-sm text-gray-600 mb-4">
                                    Available: <strong id="availableWithdraw">0</strong> mUSDC
                                </p>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Withdraw Amount</label>
                                        <div class="relative">
                                            <input type="number" id="withdrawAmount" placeholder="0.00" 
                                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                            <span class="absolute right-4 top-3.5 text-gray-500 font-medium">mUSDC</span>
                                        </div>
                                    </div>
                                    
                                    <button id="withdrawBtn" class="w-full bg-gray-600 text-white py-3 rounded-lg font-semibold hover:bg-gray-700 transition-colors">
                                        Withdraw
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dashboard Content -->
                        <div id="dashboardContent" class="hidden">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Your Positions</h3>
                            
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="font-semibold text-green-900">Deposits</span>
                                    <span>üìà</span>
                                </div>
                                <div class="flex justify-between items-center py-2">
                                    <span class="text-gray-700">mUSDC</span>
                                    <div class="text-right">
                                        <p class="font-semibold text-gray-900" id="depositedAmount">0</p>
                                        <p class="text-sm text-green-600"><span id="depositedTickets">0</span> tickets</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Pool Info -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <span class="mr-2">üíµ</span>
                        Pool Statistics
                    </h3>
                    
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <span class="text-2xl">üíµ</span>
                                <span class="font-semibold text-gray-900">mUSDC</span>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700" id="utilizationBadge">
                                0% Used
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <p class="text-gray-500 mb-1">Total Deposits</p>
                                <p class="font-semibold text-gray-900" id="totalDeposits">0</p>
                            </div>
                            <div>
                                <p class="text-gray-500 mb-1">Total Borrows</p>
                                <p class="font-semibold text-gray-900" id="totalBorrows">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contract Addresses -->
                <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Contract Info</h3>
                    
                    <div class="space-y-3 text-sm">
                        <div>
                            <p class="text-gray-600 mb-1">Lending Protocol</p>
                            <p class="font-mono text-xs text-gray-900 break-all" id="lendingAddress">Not set</p>
                        </div>
                        <div>
                            <p class="text-gray-600 mb-1">MockUSDC Token</p>
                            <p class="font-mono text-xs text-gray-900 break-all" id="tokenAddress">Not set</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è REPLACE THESE WITH YOUR ACTUAL CONTRACT ADDRESSES
        const LENDING_PROTOCOL_ADDRESS = '0xA95597A9e40fCa517a95e0f5E039702379577858';
        const MOCK_USDC_ADDRESS = '0x911b4000D3422F482F4062a913885f7b035382Df';
        
        // Display addresses
        document.getElementById('lendingAddress').textContent = LENDING_PROTOCOL_ADDRESS;
        document.getElementById('tokenAddress').textContent = MOCK_USDC_ADDRESS;
        
        // ABIs
        const LENDING_PROTOCOL_ABI = [
            "function deposit(address asset, uint256 amount) external",
            "function withdraw(address asset, uint256 amount) external",
            "function getUserDepositInfo(address user, address asset) external view returns (uint256 amount, uint256 tickets)",
            "function getRaffleInfo(uint256 raffleId) external view returns (uint256 rewardPool, uint256 endTime, uint256 participantCount, bool drawn)",
            "function currentRaffleId() external view returns (uint256)",
            "function pools(address asset) external view returns (address, uint256, uint256, uint256, uint256, uint256, bool)"
        ];
        
        const ERC20_ABI = [
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function balanceOf(address account) external view returns (uint256)"
        ];
        
        let provider, signer, walletAddress;
        let lendingContract, tokenContract;
        
        // Show status message
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            const statusContent = document.getElementById('statusContent');
            
            statusDiv.classList.remove('hidden');
            statusContent.className = 'p-4 rounded-lg ';
            
            if (type === 'success') {
                statusContent.className += 'bg-green-50 text-green-800';
            } else if (type === 'error') {
                statusContent.className += 'bg-red-50 text-red-800';
            } else {
                statusContent.className += 'bg-blue-50 text-blue-800';
            }
            
            statusContent.textContent = message;
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }
        
        // Connect wallet
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask!');
                return;
            }
            
            try {
                showStatus('Connecting wallet...');
                
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                const arcChainId = '0x4CE632';
                
                if (chainId !== arcChainId) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: arcChainId }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: arcChainId,
                                    chainName: 'Arc Testnet',
                                    nativeCurrency: { name: 'USDC', symbol: 'USDC', decimals: 6 },
                                    rpcUrls: ['https://arc-testnet.rpc.caldera.xyz/http'],
                                    blockExplorerUrls: ['https://testnet.arcscan.app/']
                                }]
                            });
                        }
                    }
                }
                
                walletAddress = accounts[0];
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                
                lendingContract = new ethers.Contract(LENDING_PROTOCOL_ADDRESS, LENDING_PROTOCOL_ABI, signer);
                tokenContract = new ethers.Contract(MOCK_USDC_ADDRESS, ERC20_ABI, signer);
                
                document.getElementById('connectBtn').innerHTML = `<span>‚úÖ ${walletAddress.slice(0,6)}...${walletAddress.slice(-4)}</span>`;
                document.getElementById('connectBtn').className = 'px-6 py-2.5 rounded-lg font-medium transition-all bg-green-100 text-green-700';
                
                showStatus('‚úÖ Wallet connected!', 'success');
                await loadUserData();
            } catch (error) {
                console.error(error);
                showStatus('‚ùå Error connecting wallet', 'error');
            }
        }
        
        // Load user data
        async function loadUserData() {
            try {
                // Get balance
                const balance = await tokenContract.balanceOf(walletAddress);
                document.getElementById('userBalance').textContent = parseFloat(ethers.utils.formatEther(balance)).toFixed(2);
                
                // Get deposit info
                const depositInfo = await lendingContract.getUserDepositInfo(walletAddress, MOCK_USDC_ADDRESS);
                const depositAmount = parseFloat(ethers.utils.formatEther(depositInfo.amount)).toFixed(2);
                const tickets = depositInfo.tickets.toString();
                
                document.getElementById('availableWithdraw').textContent = depositAmount;
                document.getElementById('depositedAmount').textContent = depositAmount;
                document.getElementById('depositedTickets').textContent = tickets;
                document.getElementById('yourTickets').textContent = tickets;
                
                // Get raffle info
                const raffleId = await lendingContract.currentRaffleId();
                if (raffleId.toNumber() > 0) {
                    document.getElementById('raffleId').textContent = raffleId.toString();
                    
                    const raffleInfo = await lendingContract.getRaffleInfo(raffleId);
                    document.getElementById('rewardPool').textContent = parseFloat(ethers.utils.formatEther(raffleInfo.rewardPool)).toFixed(2);
                    document.getElementById('participants').textContent = raffleInfo.participantCount.toString();
                    
                    // Update countdown
                    updateCountdown(raffleInfo.endTime.toNumber());
                }
                
                // Get pool info
                const pool = await lendingContract.pools(MOCK_USDC_ADDRESS);
                document.getElementById('totalDeposits').textContent = parseFloat(ethers.utils.formatEther(pool[1])).toFixed(2);
                document.getElementById('totalBorrows').textContent = parseFloat(ethers.utils.formatEther(pool[2])).toFixed(2);
                
                const utilization = pool[3].toNumber() / 100;
                document.getElementById('utilizationBadge').textContent = `${utilization.toFixed(1)}% Used`;
                
                // Check allowance
                const allowance = await tokenContract.allowance(walletAddress, LENDING_PROTOCOL_ADDRESS);
                if (allowance.eq(0)) {
                    document.getElementById('approvalSection').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        // Update countdown
        function updateCountdown(endTime) {
            setInterval(() => {
                const now = Math.floor(Date.now() / 1000);
                const diff = endTime - now;
                
                if (diff <= 0) {
                    document.getElementById('timeRemaining').textContent = 'Ended';
                    return;
                }
                
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                
                if (minutes > 60) {
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    document.getElementById('timeRemaining').textContent = `${hours}h ${mins}m`;
                } else {
                    document.getElementById('timeRemaining').textContent = `${minutes}m ${seconds}s`;
                }
            }, 1000);
        }
        
        // Approve tokens
        async function approveTokens() {
            try {
                showStatus('Approving tokens...');
                const tx = await tokenContract.approve(LENDING_PROTOCOL_ADDRESS, ethers.constants.MaxUint256);
                showStatus('Waiting for confirmation...');
                await tx.wait();
                showStatus('‚úÖ Tokens approved!', 'success');
                document.getElementById('approvalSection').classList.add('hidden');
                await loadUserData();
            } catch (error) {
                console.error(error);
                showStatus('‚ùå Error approving tokens', 'error');
            }
        }
        
        // Deposit
        async function deposit() {
            const amount = document.getElementById('depositAmount').value;
            if (!amount || parseFloat(amount) <= 0) {
                showStatus('‚ùå Please enter a valid amount', 'error');
                return;
            }
            
            try {
                showStatus('Depositing...');
                const amountWei = ethers.utils.parseEther(amount);
                const tx = await lendingContract.deposit(MOCK_USDC_ADDRESS, amountWei);
                showStatus('Waiting for confirmation...');
                await tx.wait();
                showStatus('‚úÖ Deposit successful! You earned raffle tickets!', 'success');
                document.getElementById('depositAmount').value = '';
                await loadUserData();
            } catch (error) {
                console.error(error);
                showStatus('‚ùå Error depositing: ' + error.message, 'error');
            }
        }
        
        // Withdraw
        async function withdraw() {
            const amount = document.getElementById('withdrawAmount').value;
            if (!amount || parseFloat(amount) <= 0) {
                showStatus('‚ùå Please enter a valid amount', 'error');
                return;
            }
            
            try {
                showStatus('Withdrawing...');
                const amountWei = ethers.utils.parseEther(amount);
                const tx = await lendingContract.withdraw(MOCK_USDC_ADDRESS, amountWei);
                showStatus('Waiting for confirmation...');
                await tx.wait();
                showStatus('‚úÖ Withdrawal successful!', 'success');
                document.getElementById('withdrawAmount').value = '';
                await loadUserData();
            } catch (error) {
                console.error(error);
                showStatus('‚ùå Error withdrawing: ' + error.message, 'error');
            }
        }
        
        // Event listeners
        document.getElementById('connectBtn').addEventListener('click', connectWallet);
        document.getElementById('approveBtn').addEventListener('click', approveTokens);
        document.getElementById('depositBtn').addEventListener('click', deposit);
        document.getElementById('withdrawBtn').addEventListener('click', withdraw);
        document.getElementById('refreshBtn').addEventListener('click', loadUserData);
        
        // Tab switching
        document.getElementById('lendTab').addEventListener('click', () => {
            document.getElementById('lendContent').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('lendTab').className = 'flex-1 px-6 py-4 font-semibold bg-indigo-50 text-indigo-600 border-b-2 border-indigo-600';
            document.getElementById('dashboardTab').className = 'flex-1 px-6 py-4 font-semibold text-gray-600 hover:bg-gray-50';
        });
        
        document.getElementById('dashboardTab').addEventListener('click', () => {
            document.getElementById('lendContent').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');
            document.getElementById('dashboardTab').className = 'flex-1 px-6 py-4 font-semibold bg-indigo-50 text-indigo-600 border-b-2 border-indigo-600';
            document.getElementById('lendTab').className = 'flex-1 px-6 py-4 font-semibold text-gray-600 hover:bg-gray-50';
        });
        
        // Update ticket preview
        document.getElementById('depositAmount').addEventListener('input', (e) => {
            const amount = e.target.value;
            if (amount && parseFloat(amount) > 0) {
                const tickets = Math.floor(parseFloat(amount));
                document.getElementById('ticketsPreview').textContent = `‚âà ${tickets} raffle tickets`;
            } else {
                document.getElementById('ticketsPreview').textContent = '';
            }
        });
    </script>
</body>
</html>
